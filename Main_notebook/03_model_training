# ğŸ“Œ 03_model_training.ipynb
# Objetivo: Procesar la seÃ±al de ECG y extraer picos R para la segmentaciÃ³n

import numpy as np
import matplotlib.pyplot as plt
import neurokit2 as nk
import wfdb

# ğŸ“‚ Definir la ruta de los datos
training_path = "/content/drive/My Drive/PSF/Training"

# âœ… Cargar la seÃ±al de ECG
r_a, _ = wfdb.rdsamp(training_path+'/0006')

# ğŸ”¹ Procesar la seÃ±al de ECG
beats = []
ecg_signal = r_a.flatten()

# ğŸ“Š Procesar la seÃ±al para detectar picos R
signals, info = nk.ecg_process(ecg_signal, sampling_rate=300)

# ğŸ” Visualizar la seÃ±al procesada
nk.ecg_plot(signals, info)

# ğŸ“Œ Segmentar la seÃ±al ECG en latidos
segmented_ecg = nk.ecg_segment(signals['ECG_Clean'], rpeaks=None, sampling_rate=300)

# ğŸ“Œ Acumular segmentos
for i in segmented_ecg.keys():
    beats.append(segmented_ecg[i]['Signal'])

beats_ecg = np.array(beats)

# ğŸ“Š VisualizaciÃ³n de los latidos
plt.figure()
plt.plot(beats_ecg.T, color=[0.5, 0.5, 0.5], linewidth=0.5)
plt.plot(np.nanmean(beats_ecg, axis=0), linewidth=2, color='k')
plt.title('Valores de cada latido en la seÃ±al de ECG')
plt.show()

# âœ… Cargar otra seÃ±al de ECG para mÃ¡s anÃ¡lisis
r_a, _ = wfdb.rdsamp(training_path+'/0003')
ecg_signal = r_a.flatten()

# ğŸ“Š Procesar la seÃ±al para detectar picos R
signals, info = nk.ecg_process(ecg_signal, sampling_rate=300)
q_peaks = info['ECG_Q_Peaks']

# ğŸ”¹ Filtrar picos sin valores NaN
lista_sin_nan = [x for x in q_peaks if not np.isnan(x)]

# ğŸ“Œ Extraer segmentos alrededor de los picos Q
vacio = []
for q in lista_sin_nan:
    vacio.append(ecg_signal[int(q) - 35: int(q)])

# ğŸ“Š Visualizar las ondas P
fig, ax = plt.subplots()
for arr in vacio:
    ax.plot(arr)
ax.set_title('Ondas P')
plt.show()